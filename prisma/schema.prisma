generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =====================
 * EXISTING AUTH MODELS
 * =====================
 */

model User {
  id         String  @id @default(cuid())
  username   String  @unique
  email      String  @unique
  password   String // bcrypt hash
  firstName  String
  lastName   String
  image      String? // profile image URL (upload kasnije)
  isVerified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // sessions/tokens
  sessions            Session[]
  verificationTokens  EmailVerificationToken[]
  passwordResetTokens PasswordResetToken[]

  // ===== back-relations for money domain =====
  accounts       Account[]
  categories     Category[]
  transactions   Transaction[]
  tags           Tag[]
  attachments    Attachment[]
  recurringRules RecurringRule[]
  budgets        Budget[]

  // ===== back-relations for PACE plan/KPI =====
  plans             Plan[]
  goals             Goal[]
  netWorthSnapshots NetWorthSnapshot[]
  holdings          Holding[]
  liabilities       Liability[]
  subscriptions     Subscription[]
  kpiSnapshots      KpiSnapshot[]
  nudgeRules        NudgeRule[]
  settings          Setting[]
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([expiresAt])
}

/**
 * ===============
 * MONEY DOMAIN
 * ===============
 */

enum TxnType {
  INCOME
  EXPENSE
}

model Account {
  id       String  @id @default(cuid())
  userId   String
  name     String
  currency String  @default("EUR")
  balance  Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  txns           Transaction[]
  recurringRules RecurringRule[]
  budgets        Budget[]
  holdings       Holding[] // <— back-relation for Holding.account

  @@unique([userId, name])
  @@index([userId])
}

model Category {
  id        String  @id @default(cuid())
  userId    String
  name      String
  icon      String?
  color     String?
  type      TxnType
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  txns    Transaction[]
  rules   RecurringRule[]
  budgets Budget[]

  @@unique([userId, type, name])
  @@index([userId])
}

model Transaction {
  id              String  @id @default(cuid())
  userId          String
  accountId       String
  categoryId      String?
  // FK to recurring rule if generated by it:
  recurringRuleId String?

  type       TxnType
  amount     Decimal
  currency   String   @default("EUR")
  occurredAt DateTime
  note       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  account   Account        @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category  Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  recurring RecurringRule? @relation(fields: [recurringRuleId], references: [id], onDelete: SetNull)

  tags        TransactionTag[]
  attachments Attachment[]

  @@index([userId, occurredAt])
  @@index([userId, type, occurredAt])
}

model Tag {
  id     String @id @default(cuid())
  userId String
  name   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  txns TransactionTag[]

  @@unique([userId, name])
  @@index([userId])
}

model TransactionTag {
  transactionId String
  tagId         String
  assignedAt    DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  tag         Tag         @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([transactionId, tagId])
}

model Attachment {
  id            String   @id @default(cuid())
  transactionId String
  userId        String
  url           String
  mimeType      String?
  createdAt     DateTime @default(now())

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model RecurringRule {
  id             String   @id @default(cuid())
  userId         String
  accountId      String
  categoryId     String?
  type           TxnType
  amount         Decimal
  currency       String   @default("EUR")
  rrule          String // "FREQ=MONTHLY;BYMONTHDAY=1" itd.
  nextOccurrence DateTime
  note           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  generatedTxns Transaction[]

  @@index([userId, nextOccurrence])
}

model Budget {
  id         String  @id @default(cuid())
  userId     String
  categoryId String?
  accountId  String?
  period     String // npr. "MONTHLY" ili "2025-10"
  limit      Decimal
  currency   String  @default("EUR")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  account  Account?  @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([userId, period])
}

/**
 * ==========================
 * PACE PLAN & KPI EXTENSION
 * ==========================
 */

enum GoalType {
  RETIREMENT
  PURCHASE
  BUFFER
  OTHER
}

enum AssetClass {
  CASH
  STOCKS
  BONDS
  GOLD
  BITCOIN
  PROPERTY
  CRYPTO_OTHER
  OTHER
}

enum LiabilityType {
  CREDIT_CARD
  CONSUMER_LOAN
  CAR_LOAN
  MORTGAGE
  OTHER
}

enum Interval {
  WEEKLY
  MONTHLY
  YEARLY
}

model Plan {
  id           String   @id @default(cuid())
  userId       String
  name         String   @default("My Wealth Plan")
  currency     String   @default("EUR")
  hurdleRatePc Decimal  @default(10) // 10% p.a. kao default
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  goals Goal[]
  notes String?

  @@unique([userId, name])
  @@index([userId])
}

model Goal {
  id           String    @id @default(cuid())
  userId       String
  planId       String
  type         GoalType
  title        String
  targetAmount Decimal
  targetDate   DateTime?
  monthlyNeed  Decimal? // cache izračuna
  isActive     Boolean   @default(true)
  notes        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
}

model NetWorthSnapshot {
  id          String   @id @default(cuid())
  userId      String
  asOf        DateTime
  assets      Decimal
  liabilities Decimal
  netWorth    Decimal
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, asOf])
  @@index([userId, asOf])
}

model Holding {
  id         String     @id @default(cuid())
  userId     String
  accountId  String?
  name       String
  assetClass AssetClass
  amount     Decimal
  currency   String     @default("EUR")
  provider   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  account Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@index([userId, assetClass])
}

model Liability {
  id             String        @id @default(cuid())
  userId         String
  name           String
  type           LiabilityType
  balance        Decimal
  interestRatePc Decimal?
  minimumPayment Decimal?
  dueDay         Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model Subscription {
  id         String    @id @default(cuid())
  userId     String
  name       String
  amount     Decimal
  currency   String    @default("EUR")
  interval   Interval  @default(MONTHLY)
  nextCharge DateTime?
  note       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model KpiSnapshot {
  id            String  @id @default(cuid())
  userId        String
  year          Int
  month         Int // 1-12
  income        Decimal
  expenses      Decimal
  savings       Decimal
  savingsRatePc Decimal // 0-100
  runwayMonths  Decimal
  paceScore     Int

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId, year, month])
}

enum NudgeCode {
  SAVINGS_RATE_LOW
  EXPENSE_SPIKE
  SUBSCRIPTION_UNUSED
  CREDIT_CARD_BALANCE
  REBALANCE_DUE
}

model NudgeRule {
  id            String    @id @default(cuid())
  userId        String
  code          NudgeCode
  isEnabled     Boolean   @default(true)
  threshold     Decimal?
  windowDays    Int?
  lastTriggered DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, code])
  @@index([userId, code])
}

model Setting {
  id     String @id @default(cuid())
  userId String
  key    String
  value  Json

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
}
